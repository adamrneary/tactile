<!DOCTYPE html>

<html>
<head>
  <title>dragger.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="base_renderer.html">
                base_renderer.coffee
              </a>
            
              
              <a class="source" href="draggable_renderer.html">
                draggable_renderer.coffee
              </a>
            
              
              <a class="source" href="series.html">
                series.coffee
              </a>
            
              
              <a class="source" href="series_set.html">
                series_set.coffee
              </a>
            
              
              <a class="source" href="tooltip.html">
                tooltip.coffee
              </a>
            
              
              <a class="source" href="utils.html">
                utils.coffee
              </a>
            
              
              <a class="source" href="index.html">
                index.coffee
              </a>
            
              
              <a class="source" href="area_renderer.html">
                area_renderer.coffee
              </a>
            
              
              <a class="source" href="axis_base.html">
                axis_base.coffee
              </a>
            
              
              <a class="source" href="axis_linear.html">
                axis_linear.coffee
              </a>
            
              
              <a class="source" href="axis_time.html">
                axis_time.coffee
              </a>
            
              
              <a class="source" href="bullet_renderer.html">
                bullet_renderer.coffee
              </a>
            
              
              <a class="source" href="chart.html">
                chart.coffee
              </a>
            
              
              <a class="source" href="column_renderer.html">
                column_renderer.coffee
              </a>
            
              
              <a class="source" href="donut_renderer.html">
                donut_renderer.coffee
              </a>
            
              
              <a class="source" href="dragger.html">
                dragger.coffee
              </a>
            
              
              <a class="source" href="fixtures_time.html">
                fixtures_time.coffee
              </a>
            
              
              <a class="source" href="gauge_renderer.html">
                gauge_renderer.coffee
              </a>
            
              
              <a class="source" href="grid.html">
                grid.coffee
              </a>
            
              
              <a class="source" href="leaderboard_renderer.html">
                leaderboard_renderer.coffee
              </a>
            
              
              <a class="source" href="line_renderer.html">
                line_renderer.coffee
              </a>
            
              
              <a class="source" href="range_slider.html">
                range_slider.coffee
              </a>
            
              
              <a class="source" href="scatter_renderer.html">
                scatter_renderer.coffee
              </a>
            
              
              <a class="source" href="waterfall_renderer.html">
                waterfall_renderer.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>dragger.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="class"><span class="keyword">class</span> <span class="title">Tactile</span>.<span class="title">Dragger</span></span>

  <span class="attribute">constructor</span>: <span class="function"><span class="params">(args)</span> -&gt;</span>
    <span class="property">@renderer</span> = args.renderer
    <span class="property">@graph</span> = <span class="property">@renderer</span>.graph
    <span class="property">@series</span> = <span class="property">@renderer</span>.series
    <span class="property">@drawCircles</span> = args.circles <span class="keyword">or</span> <span class="literal">false</span>

    <span class="property">@afterDrag</span> = <span class="property">@series</span>.afterDrag ||<span class="function"> -&gt;</span>
    <span class="property">@onDrag</span> = <span class="property">@series</span>.onDrag ||<span class="function"> -&gt;</span>
    <span class="property">@dragged</span> = <span class="literal">null</span>
    <span class="property">@_bindMouseEvents</span>()
    <span class="property">@power</span> = <span class="property">@_calculateSigFigs</span>()
    <span class="property">@setSpeed</span> = <span class="property">@renderer</span>.transitionSpeed
    <span class="property">@timesRendered</span> = <span class="number">0</span>

  <span class="attribute">_bindMouseEvents</span>:<span class="function"> -&gt;</span>
    d3.select(<span class="property">@graph</span>._element)
      .<span class="literal">on</span>(<span class="string">"mousemove.drag.<span class="subst">#{<span class="property">@series</span>.name}</span>"</span>, <span class="property">@_mouseMove</span>)
      .<span class="literal">on</span>(<span class="string">"touchmove.drag.<span class="subst">#{<span class="property">@series</span>.name}</span>"</span>, <span class="property">@_mouseMove</span>)
      .<span class="literal">on</span>(<span class="string">"mouseup.drag.<span class="subst">#{<span class="property">@series</span>.name}</span>"</span>, <span class="property">@_mouseUp</span>)
      .<span class="literal">on</span>(<span class="string">"touchend.drag.<span class="subst">#{<span class="property">@series</span>.name}</span>"</span>, <span class="property">@_mouseUp</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>We need more documentation EVERYWHERE, but at least for this concept...</p>
<p>Sigfigs stands for &quot;significant figures.&quot;</p>
<p>The idea within a dragger is that you shouldn&#39;t be able to arbitrarily
drag a node anywhere along a continuous axis, expecting the user to
differentiate between 4.5343928 and 4.5343929 (for example). In many
cases, in fact, the data being modelled only makes sense as an integer.</p>
<p>So, by default, we set sigfigs to 0 (meaning 0 decimal places), which
constrains the user&#39;s drag destination to integers. If, however, the axis
represents percentages, this will constrain to 0 or 100% (etc.). So in
this case sigfigs = 4 would allow 14.52% (stored as 0.1452).</p>
<p>In keeping with our &quot;functor&quot; strategery, the series can pass an integer
or a function that returns an integer when applied to a data point passed
as an argument.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">_calculateSigFigs</span>:<span class="function"> -&gt;</span>
    test = <span class="property">@series</span>.sigfigs
    test =  <span class="property">@renderer</span>
    test =  <span class="property">@renderer</span>.utils.ourFunctor
    test = <span class="property">@renderer</span>.utils.ourFunctor(<span class="property">@series</span>.sigfigs)

    sigfigs = <span class="property">@renderer</span>.utils.ourFunctor(<span class="property">@series</span>.sigfigs) ? <span class="number">0</span>
    Math.pow(<span class="number">10</span>, sigfigs)</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>bind dragging events to the passed nodes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">makeHandlers</span>: <span class="function"><span class="params">(nodes)</span> -&gt;</span>
    nodes = <span class="property">@_appendCircles</span>(nodes) <span class="keyword">if</span> <span class="property">@drawCircles</span>

    nodes.<span class="literal">on</span>(<span class="string">"mousedown.drag.<span class="subst">#{<span class="property">@series</span>.name}</span>"</span>, <span class="property">@_datapointDrag</span>)
      .<span class="literal">on</span>(<span class="string">"touchstart.drag.<span class="subst">#{<span class="property">@series</span>.name}</span>"</span>, <span class="property">@_datapointDrag</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>update value of a draggable node
so it&#39;s y-value will reflect currently dragged position</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">updateDraggedNode</span>: <span class="function"><span class="params">()</span> -&gt;</span>
    <span class="keyword">if</span> <span class="property">@dragged</span>?.y?
      <span class="property">@renderer</span>.seriesDraggableCanvas().selectAll(<span class="string">'circle.editable'</span>)
        .filter<span class="function"><span class="params">((d, i) =&gt; d <span class="keyword">is</span> <span class="property">@dragged</span>.d)</span>
        .<span class="title">each</span> <span class="params">(d)</span> =&gt;</span>
          d.y = <span class="property">@dragged</span>.y
          d.dragged = <span class="literal">true</span>

  <span class="attribute">_datapointDrag</span>: <span class="function"><span class="params">(d, i)</span> =&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>fix for a weird behavior that d is sometimes
an array with all the nodes of the series</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    d = <span class="keyword">if</span> _.isArray(d) <span class="keyword">then</span> d[i] <span class="keyword">else</span> d</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>lock the tooltip on the dragged element</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">return</span> <span class="keyword">unless</span> <span class="property">@renderer</span>.utils.ourFunctor(<span class="property">@series</span>.isEditable, d, i)
    Tactile.Tooltip.spotlightOn(d) <span class="keyword">if</span> <span class="property">@series</span>.tooltip
    <span class="property">@dragged</span> = {<span class="attribute">d</span>: d, <span class="attribute">i</span>: i, <span class="attribute">y</span>: d.y, <span class="attribute">x</span>: d.x, <span class="attribute">y0</span>: d.y0}
    <span class="property">@update</span>()
    d3.event.preventDefault()
    d3.event.stopPropagation()

  <span class="attribute">_mouseMove</span>:<span class="function"> =&gt;</span>
    p = d3.mouse(<span class="property">@graph</span>.draggableVis.node())
    t = d3.event.changedTouches

    <span class="keyword">if</span> <span class="property">@dragged</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>TODO: !! move this to tooltip
TODO: !! update tooltip text continuously on dragging</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> <span class="property">@series</span>.tooltip
        tip = d3.select(<span class="property">@graph</span>._element).select(<span class="string">'.tooltip'</span>)
        hoveredNode = <span class="property">@renderer</span>.seriesDraggableCanvas().selectAll(<span class="string">'circle.editable'</span>)
          .filter<span class="function"><span class="params">((d, i) =&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>fix for a weird behavior that d is sometimes
an array with all the nodes of the series</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            d = <span class="keyword">if</span> _.isArray(d) <span class="keyword">then</span> d[i] <span class="keyword">else</span> d
            _.isEqual d, <span class="property">@dragged</span>.d
          )
          .node()
          .getBoundingClientRect()

        tip.style(<span class="string">"top"</span>, <span class="string">"<span class="subst">#{hoveredNode.top}</span>px"</span>)

      <span class="property">@renderer</span>.transitionSpeed = <span class="number">0</span>
      inverted = <span class="property">@renderer</span>.yFunction().invert(Math.max(<span class="number">0</span>, Math.min(<span class="property">@graph</span>.height(), p[<span class="number">1</span>])))
      value = Math.round(inverted * <span class="property">@power</span>) / <span class="property">@power</span>
      <span class="keyword">if</span> <span class="property">@renderer</span>.unstack
        <span class="property">@dragged</span>.y = value
      <span class="keyword">else</span>
        <span class="property">@dragged</span>.y = value - <span class="property">@dragged</span>.y0
      <span class="property">@onDrag</span>(<span class="property">@dragged</span>, <span class="property">@series</span>, <span class="property">@graph</span>)
      <span class="property">@update</span>()
      d3.event.preventDefault()
      d3.event.stopPropagation()


  <span class="attribute">_mouseUp</span>:<span class="function"> =&gt;</span>
    <span class="keyword">return</span> <span class="keyword">unless</span> <span class="property">@dragged</span>?.y?
    <span class="keyword">if</span> <span class="property">@dragged</span>.d.source
      y = <span class="property">@dragged</span>.y / <span class="property">@dragged</span>.d.source.length
      _.each <span class="property">@dragged</span>.d.source, <span class="function"><span class="params">(d)</span> =&gt;</span>
        <span class="property">@afterDrag</span>(d, y) <span class="keyword">if</span> <span class="property">@dragged</span>
    <span class="keyword">else</span>
      <span class="property">@afterDrag</span>(<span class="property">@dragged</span>.d, <span class="property">@dragged</span>.y, <span class="property">@dragged</span>.i, <span class="property">@series</span>, <span class="property">@graph</span>) <span class="keyword">if</span> <span class="property">@dragged</span>

    <span class="property">@renderer</span>.seriesDraggableCanvas().selectAll(<span class="string">'circle.editable'</span>)
      .data(<span class="property">@renderer</span>.aggdata)
      .attr<span class="function"><span class="params">(<span class="string">"class"</span>, (d) =&gt;
        d.dragged = <span class="literal">false</span>
        <span class="string">"editable"</span>)</span>
    <span class="title">d3</span>.<span class="title">select</span><span class="params">(<span class="string">"body"</span>)</span>.<span class="title">style</span> "<span class="title">cursor</span>", "<span class="title">auto</span>"
    @<span class="title">dragged</span> = <span class="title">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>unlock the tooltip from the dragged element</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    Tactile.Tooltip.turnOffspotlight() <span class="keyword">if</span> <span class="property">@series</span>.tooltip

    <span class="property">@renderer</span>.transitionSpeed = <span class="property">@setSpeed</span>
    <span class="property">@update</span>()
    d3.event.preventDefault()
    d3.event.stopPropagation()

  <span class="attribute">update</span>:<span class="function"> =&gt;</span>
    <span class="property">@renderer</span>.render()


  <span class="attribute">_appendCircles</span>: <span class="function"><span class="params">(nodes)</span> -&gt;</span>
    renderer = <span class="property">@renderer</span>

    circs = <span class="property">@renderer</span>.seriesDraggableCanvas().selectAll(<span class="string">'circle'</span>)
      .data(<span class="property">@series</span>.stack)</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>append the circles but make them invisible</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    circs.enter().append(<span class="string">"svg:circle"</span>).style(<span class="string">'display'</span>, <span class="string">'none'</span>)

    circs
      .attr(<span class="string">"r"</span>, <span class="number">4</span>)
      .attr(<span class="string">"clip-path"</span>, <span class="string">"url(#scatter-clip)"</span>)
      .attr<span class="function"><span class="params">(<span class="string">"class"</span>, (d, i) =&gt;
        [(<span class="string">"active"</span> <span class="keyword">if</span> d <span class="keyword">is</span> renderer.active), # apply active class <span class="keyword">for</span> active element
         (<span class="string">"editable"</span> <span class="keyword">if</span> renderer.utils.ourFunctor(renderer.series.isEditable, d, i))].join(<span class="string">' '</span>))</span> # <span class="title">apply</span> <span class="title">editable</span> <span class="title">class</span> <span class="title">for</span> <span class="title">editable</span> <span class="title">element</span>
      .<span class="title">attr</span><span class="params">(<span class="string">"fill"</span>, (d) =&gt; (<span class="keyword">if</span> d.dragged <span class="keyword">or</span> d <span class="keyword">is</span> renderer.active <span class="keyword">then</span> <span class="string">'white'</span> <span class="keyword">else</span> <span class="property">@series</span>.color))</span>
      .<span class="title">attr</span><span class="params">(<span class="string">"stroke"</span>, (d) =&gt; (<span class="keyword">if</span> d.dragged <span class="keyword">or</span> d <span class="keyword">is</span> renderer.active <span class="keyword">then</span> <span class="property">@series</span>.color <span class="keyword">else</span> <span class="string">'white'</span>))</span>
      .<span class="title">attr</span><span class="params">(<span class="string">"stroke-width"</span>, <span class="string">'2'</span>)</span>
      .<span class="title">attr</span><span class="params">(<span class="string">'id'</span>, (d, i) -&gt; <span class="string">"node-<span class="subst">#{i}</span>-<span class="subst">#{d.x}</span>"</span>)</span>
      .<span class="title">style</span><span class="params">(<span class="string">"cursor"</span>, (d, i)=&gt; <span class="keyword">if</span> renderer.utils.ourFunctor(<span class="property">@series</span>.isEditable, d, i) <span class="keyword">then</span> <span class="string">"ns-resize"</span> <span class="keyword">else</span> <span class="string">"auto"</span>)</span>

    <span class="title">circs</span>
      .<span class="title">transition</span><span class="params">()</span>
      .<span class="title">duration</span><span class="params">(<span class="keyword">if</span> <span class="property">@timesRendered</span>++ <span class="keyword">is</span> <span class="number">0</span> <span class="keyword">then</span> <span class="number">0</span> <span class="keyword">else</span> <span class="property">@renderer</span>.transitionSpeed)</span>
      .<span class="title">attr</span><span class="params">(<span class="string">"cx"</span>, (d) =&gt; <span class="property">@graph</span>.x d.x)</span>
      .<span class="title">attr</span><span class="params">(<span class="string">"cy"</span>, (d) =&gt; <span class="property">@graph</span>.y d.y)</span></pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>show and hide the circle for the currently hovered element</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    nodes.<span class="literal">on</span> <span class="string">'mouseover.show-dragging-circle'</span>, <span class="function"><span class="params">(d, i, el)</span> -&gt;</span>
      renderer.seriesDraggableCanvas().selectAll(<span class="string">'circle:not(.active)'</span>)
        .style(<span class="string">'display'</span>, <span class="string">'none'</span>)
      circ = renderer.seriesDraggableCanvas().select(<span class="string">"#node-<span class="subst">#{i}</span>-<span class="subst">#{d.x}</span>"</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>TODO: circle should be placed at the middle of a column
hoveredNode = d3.select(@).node().getBBox()
circ.attr(&#39;cx&#39;, hoveredNode.x + hoveredNode.width / 2)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      circ.style(<span class="string">'display'</span>, <span class="string">''</span>)

    circs.tooltip <span class="function"><span class="params">(d, i)</span> =&gt;</span>
      <span class="attribute">graph</span>: <span class="property">@graph</span>
      <span class="attribute">text</span>: <span class="property">@series</span>.tooltip(d)
      <span class="attribute">circleOnHover</span>: <span class="literal">true</span>
      <span class="attribute">gravity</span>: <span class="string">"right"</span>

    renderer.seriesDraggableCanvas().selectAll(<span class="string">'circle.editable'</span>)</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
