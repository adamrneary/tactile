<!DOCTYPE html>

<html>
<head>
  <title>axis_time.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="base_renderer.html">
                base_renderer.coffee
              </a>
            
              
              <a class="source" href="draggable_renderer.html">
                draggable_renderer.coffee
              </a>
            
              
              <a class="source" href="series.html">
                series.coffee
              </a>
            
              
              <a class="source" href="series_set.html">
                series_set.coffee
              </a>
            
              
              <a class="source" href="tooltip.html">
                tooltip.coffee
              </a>
            
              
              <a class="source" href="utils.html">
                utils.coffee
              </a>
            
              
              <a class="source" href="index.html">
                index.coffee
              </a>
            
              
              <a class="source" href="area_renderer.html">
                area_renderer.coffee
              </a>
            
              
              <a class="source" href="axis_base.html">
                axis_base.coffee
              </a>
            
              
              <a class="source" href="axis_linear.html">
                axis_linear.coffee
              </a>
            
              
              <a class="source" href="axis_time.html">
                axis_time.coffee
              </a>
            
              
              <a class="source" href="bullet_renderer.html">
                bullet_renderer.coffee
              </a>
            
              
              <a class="source" href="chart.html">
                chart.coffee
              </a>
            
              
              <a class="source" href="column_renderer.html">
                column_renderer.coffee
              </a>
            
              
              <a class="source" href="donut_renderer.html">
                donut_renderer.coffee
              </a>
            
              
              <a class="source" href="dragger.html">
                dragger.coffee
              </a>
            
              
              <a class="source" href="fixtures_time.html">
                fixtures_time.coffee
              </a>
            
              
              <a class="source" href="gauge_renderer.html">
                gauge_renderer.coffee
              </a>
            
              
              <a class="source" href="grid.html">
                grid.coffee
              </a>
            
              
              <a class="source" href="leaderboard_renderer.html">
                leaderboard_renderer.coffee
              </a>
            
              
              <a class="source" href="line_renderer.html">
                line_renderer.coffee
              </a>
            
              
              <a class="source" href="range_slider.html">
                range_slider.coffee
              </a>
            
              
              <a class="source" href="scatter_renderer.html">
                scatter_renderer.coffee
              </a>
            
              
              <a class="source" href="waterfall_renderer.html">
                waterfall_renderer.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>axis_time.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="class"><span class="keyword">class</span> <span class="title">Tactile</span>.<span class="title">AxisTime</span> <span class="keyword">extends</span> <span class="title">Tactile</span>.<span class="title">AxisBase</span></span>
  <span class="attribute">constructor</span>: <span class="function"><span class="params">(options)</span> -&gt;</span>
    <span class="property">@horizontal</span> = <span class="literal">true</span>
    <span class="keyword">super</span>
    <span class="property">@_checkOptions</span>()

    <span class="property">@fixedTimeUnit</span> = options.timeUnit
    <span class="property">@marginTop</span> = options.paddingBottom <span class="keyword">or</span> <span class="number">5</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>   @time = new Tactile.FixturesTime()</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="property">@grid</span> = options.grid
    <span class="property">@tickSize</span> = options.tickSize <span class="keyword">or</span> <span class="number">2</span>
    <span class="property">@tickValues</span> = options.tickValues <span class="keyword">or</span> <span class="literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>   @tickFormat = options.tickFormat or (d) -&gt; @appropriateTimeUnit().formatter(new Date(d))</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="property">@tickFormat</span> = options.tickFormat <span class="keyword">or</span> <span class="literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p> appropriateTimeUnit: -&gt;
   unit = undefined
   units = @time.units
   domain = @graph.x.domain()
   rangeSeconds = domain[1] - domain[0]
   units.forEach (u) -&gt;
     unit = unit or u if Math.floor(rangeSeconds / u.seconds) &gt;= 2</p>
<p>   unit or @time.units[@time.units.length - 1]</p>
<p> tickOffsets: -&gt;
   domain = @graph.x.domain()
   unit = @fixedTimeUnit or @appropriateTimeUnit()</p>
<p>   if unit.name is &quot;month&quot;
     domainMin = domain[0] - 86400000<em>3
     domainMax = domain[1] + 86400000</em>3
   else
     domainMin = domain[0]
     domainMax = domain[1]</p>
<p>   offsets = []</p>
<p>   runningTick = domainMin
   tickValue = @time.ceil(runningTick, unit)</p>
<p>   while tickValue &lt;= domainMax
     offsets.push
       value: tickValue
       unit: unit</p>
<pre><code> runningTick = tickValue + unit.seconds / 2
 tickValue = @time.ceil(runningTick, unit)</code></pre>
<p>   offsets</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="attribute">render</span>: <span class="function"><span class="params">(originalTransition)</span>-&gt;</span>
    <span class="keyword">return</span> <span class="keyword">unless</span> <span class="property">@graph</span>.x?

    domain = <span class="property">@graph</span>.x.domain()
    <span class="property">@transition</span> = originalTransition <span class="keyword">if</span> originalTransition
    <span class="property">@aggregated</span> = _.some(_.values(<span class="property">@graph</span>.aggregated))
    <span class="property">@aggLabels</span> = <span class="property">@_getLabels</span>(domain)

    <span class="property">@g</span> = <span class="property">@graph</span>.vis.selectAll(<span class="string">'g.x-ticks'</span>).data([<span class="number">0</span>])
    <span class="property">@g</span>.enter().append(<span class="string">'g'</span>).attr(<span class="string">'class'</span>, <span class="string">'x-ticks'</span>)

    ticks = <span class="property">@g</span>.selectAll(<span class="string">'g.x-tick'</span>)
      .data(<span class="property">@aggLabels</span>)

    ticks.enter()
      .append(<span class="string">'g'</span>)
      .attr(<span class="string">"class"</span>, [<span class="string">"x-tick"</span>, <span class="property">@ticksTreatment</span>].join(<span class="string">' '</span>))
      .attr <span class="string">"transform"</span>, <span class="function"><span class="params">(d, i)</span> =&gt;</span>
        <span class="string">"translate(<span class="subst">#{<span class="property">@graph</span>.outerWidth*<span class="number">1.1</span>}</span>, <span class="subst">#{<span class="property">@graph</span>.height() + <span class="property">@marginForBottomTicks</span>}</span>)"</span>

    <span class="property">@transition</span>.selectAll(<span class="string">".x-tick"</span>)
      .attr<span class="function"><span class="params">(<span class="string">"transform"</span>, (d, i) =&gt;
        <span class="keyword">if</span> <span class="property">@aggregated</span>
          <span class="string">"translate(<span class="subst">#{<span class="property">@_tickX</span>(d.value, i)}</span>, <span class="subst">#{<span class="property">@graph</span>.height() + <span class="property">@marginForBottomTicks</span>}</span>)"</span>
        <span class="keyword">else</span>
          <span class="string">"translate(<span class="subst">#{<span class="property">@graph</span>.x(d.value)}</span>, <span class="subst">#{<span class="property">@graph</span>.height() + <span class="property">@marginForBottomTicks</span>}</span>)"</span>)</span>
    .<span class="title">each</span> "<span class="title">end</span>", <span class="params">(d)</span> -&gt;</span>
        ticks.exit().remove()

    <span class="property">@g</span>.selectAll<span class="function"><span class="params">(<span class="string">'g.x-tick'</span>)</span>.<span class="title">each</span><span class="params">((d, i)-&gt;
      text = d3.select(@).selectAll(<span class="string">"text"</span>).data([d])
      text.enter()
        .append(<span class="string">"text"</span>)
        .attr(<span class="string">"class"</span>, <span class="string">"title"</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <pre><code>   .style(&quot;cursor&quot;, &quot;ew-resize&quot;)</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>      text.exit().remove()
    )</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>   @g.selectAll(&quot;text&quot;)
     .on(&quot;mousedown.drag&quot;,  @_axisDrag)
     .on(&quot;touchstart.drag&quot;, @_axisDrag)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    text = <span class="property">@g</span>.selectAll(<span class="string">"g.x-tick"</span>).selectAll(<span class="string">"text"</span>)
    text.attr(<span class="string">"y"</span>, <span class="property">@marginTop</span>)
      .text<span class="function"><span class="params">((d) -&gt;
        <span class="keyword">if</span> d.value &lt; domain[<span class="number">0</span>]
          <span class="string">""</span>
        <span class="keyword">else</span>
          d.label
      )</span>
    <span class="title">if</span> @<span class="title">aggregated</span>
      <span class="title">text</span>.<span class="title">append</span><span class="params">(<span class="string">"tspan"</span>)</span>
        .<span class="title">attr</span><span class="params">(<span class="string">"y"</span>, <span class="property">@marginTop</span> + <span class="property">@fontSize</span>)</span>
        .<span class="title">attr</span><span class="params">(<span class="string">"x"</span>, <span class="number">0</span>)</span>
        .<span class="title">text</span> <span class="params">(d)</span> -&gt;</span> d.secondary

  <span class="attribute">_checkOptions</span>: <span class="function"><span class="params">()</span>=&gt;</span>
    <span class="keyword">if</span> <span class="property">@options</span>.ticksTreatment?
      <span class="property">@utils</span>.checkString(<span class="property">@options</span>.ticksTreatment, <span class="string">"AxisTime options.ticksTreatment"</span>)

    <span class="keyword">if</span> <span class="property">@options</span>.timeUnit?
      <span class="property">@utils</span>.checkNumber(<span class="property">@options</span>.timeUnit, <span class="string">"AxisTime options.timeUnit"</span>)

    <span class="keyword">if</span> <span class="property">@options</span>.paddingBottom?
      <span class="property">@utils</span>.checkNumber(<span class="property">@options</span>.paddingBottom, <span class="string">"AxisTime options.paddingBottom"</span>)

    <span class="keyword">if</span> <span class="property">@options</span>.frame?
      <span class="keyword">if</span> <span class="property">@utils</span>.checkArray(<span class="property">@options</span>.frame, <span class="string">"AxisTime options.frame"</span>)
        <span class="property">@options</span>.frame.forEach<span class="function"><span class="params">((d, i)=&gt;
          <span class="property">@utils</span>.checkNumber(d, <span class="string">"AxisTime options.frame[<span class="subst">#{i}</span>]"</span>) <span class="keyword">if</span> d?
        )</span>

  <span class="title">_getLabels</span>: <span class="params">(timeFrame)</span> -&gt;</span>
    dataTimeFrame = <span class="property">@utils</span>.getWholeDataTimeRange(<span class="property">@graph</span>.series.array)

    labels = []

    date = [<span class="keyword">new</span> Date(timeFrame[<span class="number">0</span>]), <span class="keyword">new</span> Date(timeFrame[<span class="number">1</span>])]</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>calculate count of month in timeFrame</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    startYear = date[<span class="number">0</span>].getFullYear()
    startMonth = date[<span class="number">0</span>].getMonth()

    endYear = date[<span class="number">1</span>].getFullYear()
    endMonth = date[<span class="number">1</span>].getMonth()

    range = (endYear - startYear) * <span class="number">12</span> + (endMonth - startMonth) + <span class="number">1</span>
    rangeBefore = <span class="property">@utils</span>.domainMonthRange([dataTimeFrame[<span class="number">0</span>], timeFrame[<span class="number">0</span>]])
    rangeAfter = <span class="property">@utils</span>.domainMonthRange([timeFrame[<span class="number">1</span>], dataTimeFrame[<span class="number">1</span>]])

    <span class="keyword">if</span> range &lt;= <span class="number">12</span> <span class="keyword">or</span> !<span class="property">@aggregated</span>
      grouper = <span class="number">1</span>
      <span class="function"><span class="title">Add</span> = <span class="params">(i)</span> =&gt;</span>
        tmpDate = <span class="keyword">new</span> Date(timeFrame[<span class="number">0</span>])
        tmpDate.setMonth(startMonth + i);
        item =
          <span class="attribute">value</span>: tmpDate.getTime()
          <span class="attribute">label</span>: tmpDate.toUTCString().split(<span class="string">' '</span>)[<span class="number">2</span>]
          <span class="attribute">secondary</span>: tmpDate.getFullYear().toString()</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Else if there are 36 or fewer periods to display, we will display
quarterly data and aggregate</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">else</span> <span class="keyword">if</span> <span class="number">12</span> &lt; range &lt;= <span class="number">36</span>
      grouper = <span class="number">3</span>
      <span class="function"><span class="title">Add</span> = <span class="params">(i)</span> =&gt;</span>
        item = {}

        startDate = <span class="keyword">new</span> Date(timeFrame[<span class="number">0</span>])
        startDate.setMonth(startMonth + i)
        endDate = <span class="keyword">new</span> Date(timeFrame[<span class="number">0</span>])
        endDate.setMonth(startMonth + i + grouper - <span class="number">1</span>)

        item.value = startDate.getTime()

        item.label = <span class="string">"<span class="subst">#{startDate.toUTCString().split(<span class="string">' '</span>)[<span class="number">2</span>]}</span>-<span class="subst">#{endDate.toUTCString().split(<span class="string">' '</span>)[<span class="number">2</span>]}</span>"</span>
        <span class="keyword">if</span> startDate.getTime() <span class="keyword">is</span> date[<span class="number">1</span>].getTime()
          item.label = startDate.toUTCString().split(<span class="string">' '</span>)[<span class="number">2</span>]
        <span class="keyword">else</span> <span class="keyword">if</span> endDate.getTime() &gt; date[<span class="number">1</span>].getTime()
          endDate = date[<span class="number">1</span>]
          item.label = <span class="string">"<span class="subst">#{startDate.toUTCString().split(<span class="string">' '</span>)[<span class="number">2</span>]}</span>-<span class="subst">#{endDate.toUTCString().split(<span class="string">' '</span>)[<span class="number">2</span>]}</span>"</span>
        item.secondary = <span class="string">"<span class="subst">#{endDate.getFullYear()}</span>"</span>
        item</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>If there are more than 36 columns to display, we will display annual
data and aggregate.</p>
<p>TODO: We should probably explode gracefully if there are more than
144 periods to display</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">else</span>
      grouper = <span class="number">12</span>
      <span class="function"><span class="title">Add</span> = <span class="params">(i)</span> =&gt;</span>
        item = {}
        item.secondary = <span class="string">""</span>

        startDate = <span class="keyword">new</span> Date(timeFrame[<span class="number">0</span>])
        startDate.setMonth(startMonth + i)
        endDate = <span class="keyword">new</span> Date(timeFrame[<span class="number">0</span>])
        endDate.setMonth(startMonth + i + grouper - <span class="number">1</span>)

        item.value = startDate.getTime()
        <span class="keyword">if</span> endDate.getTime() &gt; date[<span class="number">1</span>].getTime()
          endDate = date[<span class="number">1</span>]

        <span class="keyword">if</span> startDate.getMonth() <span class="keyword">is</span> <span class="number">0</span> <span class="comment"># Jan</span>
          item.label = <span class="string">"<span class="subst">#{startDate.getFullYear()}</span>"</span>
        <span class="keyword">else</span> <span class="keyword">if</span> startDate.getTime() <span class="keyword">is</span> endDate.getTime()
          item.label = <span class="string">"<span class="subst">#{startDate.getMonth()+<span class="number">1</span>}</span>/<span class="subst">#{startDate.getFullYear()}</span>"</span>
        <span class="keyword">else</span>
          item.label = <span class="string">"<span class="subst">#{startDate.getMonth()+<span class="number">1</span>}</span>/<span class="subst">#{startDate.getFullYear()}</span>-<span class="subst">#{endDate.getMonth()+<span class="number">1</span>}</span>/<span class="subst">#{endDate.getFullYear()}</span>"</span>
        <span class="keyword">return</span> item</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>extend from left with negotive indexes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">for</span> i <span class="keyword">in</span> [-<span class="number">1</span> .. -rangeBefore] <span class="keyword">by</span> -grouper
      labels.push Add(i)

    <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">0.</span>.range - <span class="number">1</span>] <span class="keyword">by</span> grouper
      labels.push Add(i)</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>extend array from right</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">for</span> i <span class="keyword">in</span> [range .. range+rangeAfter-<span class="number">1</span>] <span class="keyword">by</span> grouper
      labels.push Add(i)

    labels.shift()
    labels

  <span class="attribute">_tickX</span>: <span class="function"><span class="params">(value, index)</span> -&gt;</span>
    width = <span class="property">@graph</span>.width()
    count = _.filter<span class="function"><span class="params">(<span class="property">@aggLabels</span>, (item) =&gt;
      <span class="property">@graph</span>.x.domain()[<span class="number">0</span>] &lt;= item.value &lt;= <span class="property">@graph</span>.x.domain()[<span class="number">1</span>]
    )</span>.<span class="title">length</span>
    <span class="title">offset</span> = <span class="title">_</span>.<span class="title">filter</span><span class="params">(<span class="property">@aggLabels</span>, (item) =&gt;
      item.value &lt; <span class="property">@graph</span>.x.domain()[<span class="number">0</span>]
    )</span>.<span class="title">length</span>

    <span class="params">(index - offset)</span> * <span class="params">(width / count)</span> + <span class="params">(width / count)</span> / 2</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
