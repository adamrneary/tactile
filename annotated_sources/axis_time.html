<!DOCTYPE html>

<html>
<head>
  <title>axis_time.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="base_renderer.html">
                base_renderer.coffee
              </a>
            
              
              <a class="source" href="draggable_renderer.html">
                draggable_renderer.coffee
              </a>
            
              
              <a class="source" href="series.html">
                series.coffee
              </a>
            
              
              <a class="source" href="series_set.html">
                series_set.coffee
              </a>
            
              
              <a class="source" href="tooltip.html">
                tooltip.coffee
              </a>
            
              
              <a class="source" href="utils.html">
                utils.coffee
              </a>
            
              
              <a class="source" href="index.html">
                index.coffee
              </a>
            
              
              <a class="source" href="aggregate_column_renderer.html">
                aggregate_column_renderer.coffee
              </a>
            
              
              <a class="source" href="area_renderer.html">
                area_renderer.coffee
              </a>
            
              
              <a class="source" href="axis_base.html">
                axis_base.coffee
              </a>
            
              
              <a class="source" href="axis_linear.html">
                axis_linear.coffee
              </a>
            
              
              <a class="source" href="axis_time.html">
                axis_time.coffee
              </a>
            
              
              <a class="source" href="bullet_renderer.html">
                bullet_renderer.coffee
              </a>
            
              
              <a class="source" href="chart.html">
                chart.coffee
              </a>
            
              
              <a class="source" href="column_renderer.html">
                column_renderer.coffee
              </a>
            
              
              <a class="source" href="donut_renderer.html">
                donut_renderer.coffee
              </a>
            
              
              <a class="source" href="dragger.html">
                dragger.coffee
              </a>
            
              
              <a class="source" href="fixtures_time.html">
                fixtures_time.coffee
              </a>
            
              
              <a class="source" href="gauge_renderer.html">
                gauge_renderer.coffee
              </a>
            
              
              <a class="source" href="grid.html">
                grid.coffee
              </a>
            
              
              <a class="source" href="leaderboard_renderer.html">
                leaderboard_renderer.coffee
              </a>
            
              
              <a class="source" href="line_renderer.html">
                line_renderer.coffee
              </a>
            
              
              <a class="source" href="range_slider.html">
                range_slider.coffee
              </a>
            
              
              <a class="source" href="scatter_renderer.html">
                scatter_renderer.coffee
              </a>
            
              
              <a class="source" href="waterfall_renderer.html">
                waterfall_renderer.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>axis_time.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="class"><span class="keyword">class</span> <span class="title">Tactile</span>.<span class="title">AxisTime</span> <span class="keyword">extends</span> <span class="title">Tactile</span>.<span class="title">AxisBase</span></span>
  constructor: (options) -&gt;
    <span class="property">@horizontal</span> = <span class="literal">true</span>
    <span class="keyword">super</span>
    <span class="property">@_checkOptions</span>()

    <span class="property">@fixedTimeUnit</span> = options.timeUnit
    <span class="property">@marginTop</span> = options.paddingBottom <span class="keyword">or</span> <span class="number">5</span>
    <span class="property">@time</span> = <span class="keyword">new</span> Tactile.FixturesTime()
    <span class="property">@grid</span> = options.grid

  appropriateTimeUnit: -&gt;
    unit = <span class="literal">undefined</span>
    units = <span class="property">@time</span>.units
    domain = <span class="property">@graph</span>.x.domain()
    rangeSeconds = domain[<span class="number">1</span>] - domain[<span class="number">0</span>]
    units.forEach (u) -&gt;
      unit = unit <span class="keyword">or</span> u <span class="keyword">if</span> Math.floor(rangeSeconds / u.seconds) &gt;= <span class="number">2</span>

    unit <span class="keyword">or</span> <span class="property">@time</span>.units[<span class="property">@time</span>.units.length - <span class="number">1</span>]

  tickOffsets: -&gt;
    domain = <span class="property">@graph</span>.x.domain()</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>if      domain.length &lt;= 12 months
  do this logic
  or replace it all
else if domain.length &gt; 12 months
  offsets = [] = _aggregatedByMonth()</p>
<p>_aggregatedByMonth() shuld return array of
[
  value: unixTimeStamp
  label: &quot;Jan&quot;, &quot;Feb&quot;, ... || &quot;Jan - Mar&quot;, &quot;Apr - Jun&quot;, ... || Year
  secondaryLabel: Optional???
]</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    unit = <span class="property">@fixedTimeUnit</span> <span class="keyword">or</span> <span class="property">@appropriateTimeUnit</span>()

    <span class="keyword">if</span> unit.name <span class="keyword">is</span> <span class="string">"month"</span>
      domainMin = domain[<span class="number">0</span>] - <span class="number">86400000</span>*<span class="number">3</span>
      domainMax = domain[<span class="number">1</span>] + <span class="number">86400000</span>*<span class="number">3</span>
    <span class="keyword">else</span>
      domainMin = domain[<span class="number">0</span>]
      domainMax = domain[<span class="number">1</span>]

    offsets = []

    runningTick = domainMin
    tickValue = <span class="property">@time</span>.ceil(runningTick, unit)

    <span class="keyword">while</span> tickValue &lt;= domainMax
      offsets.push
        value: tickValue
        unit: unit

      runningTick = tickValue + unit.seconds / <span class="number">2</span>
      tickValue = <span class="property">@time</span>.ceil(runningTick, unit)

    offsets

  render: (transition)-&gt;
    <span class="keyword">return</span> <span class="keyword">unless</span> <span class="property">@graph</span>.x?

    <span class="property">@g</span> = <span class="property">@graph</span>.vis.selectAll(<span class="string">'g.x-ticks'</span>).data([<span class="number">0</span>])
    <span class="property">@g</span>.enter().append(<span class="string">'g'</span>).attr(<span class="string">'class'</span>, <span class="string">'x-ticks'</span>)


    ticks = <span class="property">@g</span>.selectAll(<span class="string">'g.x-tick'</span>)
      .data(<span class="property">@_getLabels</span>(<span class="property">@graph</span>.x.domain()))

    ticks.enter()
      .append(<span class="string">'g'</span>)
      .attr(<span class="string">"class"</span>, [<span class="string">"x-tick"</span>, <span class="property">@ticksTreatment</span>].join(<span class="string">' '</span>))

    ticks
      .attr(<span class="string">"transform"</span>,
        (d) =&gt;
          <span class="string">"translate(<span class="subst">#{@graph.x(d.value)}</span>, <span class="subst">#{@graph.height() + @marginForBottomTicks}</span>)"</span>)

    ticks.exit().remove()

    <span class="property">@g</span>.selectAll(<span class="string">'g.x-tick'</span>).each((d, i)-&gt;
      text = d3.select(@).selectAll(<span class="string">"text"</span>).data([d])
      text.enter()
        .append(<span class="string">"text"</span>)
        .attr(<span class="string">"class"</span>, <span class="string">"title"</span>)
        .style(<span class="string">"cursor"</span>, <span class="string">"ew-resize"</span>)
      text.exit().remove()
    )

    <span class="property">@g</span>.selectAll(<span class="string">"text"</span>)
      .<span class="literal">on</span>(<span class="string">"mousedown.drag"</span>,  <span class="property">@_axisDrag</span>)
      .<span class="literal">on</span>(<span class="string">"touchstart.drag"</span>, <span class="property">@_axisDrag</span>)

    <span class="property">@g</span>.selectAll(<span class="string">"g.x-tick"</span>).selectAll(<span class="string">"text"</span>)
      .attr(<span class="string">"y"</span>, <span class="property">@marginTop</span>)
      .text((d) -&gt; d.label)
      .append(<span class="string">"tspan"</span>)
        .attr(<span class="string">"y"</span>, <span class="property">@marginTop</span> + <span class="property">@fontSize</span>)
        .attr(<span class="string">"x"</span>, <span class="number">0</span>)
        .text (d) -&gt; d.secondary

  _checkOptions: ()=&gt;
    <span class="keyword">if</span> <span class="property">@options</span>.ticksTreatment?
      <span class="property">@utils</span>.checkString(<span class="property">@options</span>.ticksTreatment, <span class="string">"AxisTime options.ticksTreatment"</span>)

    <span class="keyword">if</span> <span class="property">@options</span>.timeUnit?
      <span class="property">@utils</span>.checkNumber(<span class="property">@options</span>.timeUnit, <span class="string">"AxisTime options.timeUnit"</span>)

    <span class="keyword">if</span> <span class="property">@options</span>.paddingBottom?
      <span class="property">@utils</span>.checkNumber(<span class="property">@options</span>.paddingBottom, <span class="string">"AxisTime options.paddingBottom"</span>)

    <span class="keyword">if</span> <span class="property">@options</span>.frame?
      <span class="keyword">if</span> <span class="property">@utils</span>.checkArray(<span class="property">@options</span>.frame, <span class="string">"AxisTime options.frame"</span>)
        <span class="property">@options</span>.frame.forEach((d, i)=&gt;
          <span class="property">@utils</span>.checkNumber(d, <span class="string">"AxisTime options.frame[<span class="subst">#{i}</span>]"</span>) <span class="keyword">if</span> d?
        )

  _getLabels: (timeFrame) -&gt;
    labels = []

    date = [<span class="keyword">new</span> Date(timeFrame[<span class="number">0</span>]), <span class="keyword">new</span> Date(timeFrame[<span class="number">1</span>])]</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>calculate count of month in timeFrame</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    startYear = date[<span class="number">0</span>].getFullYear()
    startMonth = date[<span class="number">0</span>].getMonth()

    endYear = date[<span class="number">1</span>].getFullYear()
    endMonth = date[<span class="number">1</span>].getMonth()

    range = (endYear - startYear) * <span class="number">12</span> + (endMonth - startMonth) + <span class="number">1</span>

    <span class="keyword">if</span> range &lt;= <span class="number">12</span>
      <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">0.</span>.range - <span class="number">1</span>]
        tmpDate = <span class="keyword">new</span> Date(timeFrame[<span class="number">0</span>])
        tmpDate.setMonth(startMonth + i);
        labels.push
          value: tmpDate.getTime()
          label: tmpDate.toUTCString().split(<span class="string">' '</span>)[<span class="number">2</span>]
          secondary: tmpDate.getFullYear().toString()</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Else if there are 36 or fewer periods to display, we will display
quarterly data and aggregate</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">else</span> <span class="keyword">if</span> <span class="number">12</span> &lt; range &lt;= <span class="number">36</span>
      grouper = <span class="number">3</span>
      <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">0</span> .. (range - <span class="number">1</span>)] <span class="keyword">by</span> grouper
        item = {}

        startDate = <span class="keyword">new</span> Date(timeFrame[<span class="number">0</span>])
        startDate.setMonth(startMonth + i)
        endDate = <span class="keyword">new</span> Date(timeFrame[<span class="number">0</span>])
        endDate.setMonth(startMonth + i + grouper - <span class="number">1</span>)

        item.value = startDate.getTime()

        item.label = <span class="string">"<span class="subst">#{startDate.toUTCString().split(' ')[<span class="number">2</span>]}</span> - <span class="subst">#{endDate.toUTCString().split(' ')[<span class="number">2</span>]}</span>"</span>
        <span class="keyword">if</span> startDate.getTime() <span class="keyword">is</span> date[<span class="number">1</span>].getTime()
          item.label = startDate.toUTCString().split(<span class="string">' '</span>)[<span class="number">2</span>]
        <span class="keyword">else</span> <span class="keyword">if</span> endDate.getTime() &gt; date[<span class="number">1</span>].getTime()
          endDate = date[<span class="number">1</span>]
          item.label = <span class="string">"<span class="subst">#{startDate.toUTCString().split(' ')[<span class="number">2</span>]}</span> - <span class="subst">#{endDate.toUTCString().split(' ')[<span class="number">2</span>]}</span>"</span>
        item.secondary = <span class="string">"<span class="subst">#{endDate.getFullYear()}</span>"</span>

        labels.push item</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>If there are more than 36 columns to display, we will display annual
data and aggregate.</p>
<p>TODO: We should probably explode gracefully if there are more than
144 periods to display</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">else</span>
      grouper = <span class="number">12</span>
      <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">0</span> .. (range - <span class="number">1</span>)] <span class="keyword">by</span> grouper
        item = {}
        item.secondary = <span class="string">""</span>

        startDate = <span class="keyword">new</span> Date(timeFrame[<span class="number">0</span>])
        startDate.setMonth(startMonth + i)
        endDate = <span class="keyword">new</span> Date(timeFrame[<span class="number">0</span>])
        endDate.setMonth(startMonth + i + grouper - <span class="number">1</span>)

        item.value = startDate.getTime()
        <span class="keyword">if</span> endDate.getTime() &gt; date[<span class="number">1</span>].getTime()
          endDate = date[<span class="number">1</span>]

        <span class="keyword">if</span> startDate.getMonth() <span class="keyword">is</span> <span class="number">0</span> <span class="comment"># Jan</span>
          item.label = <span class="string">"<span class="subst">#{startDate.getFullYear()}</span>"</span>
        <span class="keyword">else</span>
          item.label = <span class="string">"<span class="subst">#{startDate.getMonth()+<span class="number">1</span>}</span>/<span class="subst">#{startDate.getFullYear()}</span> - <span class="subst">#{startDate.getMonth()}</span>/<span class="subst">#{endDate.getFullYear()}</span>"</span>

        labels.push item
    labels</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
